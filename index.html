<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.5">
    <title>KY Secret V3 Â· åŒ¿åæŠ•ç¨¿</title>
    <script>
    // ========= KY Secret V3 åŠ¨æ€é…ç½®åŠ è½½ =========
    window.KY_CONFIG = {
        backendUrl: '',
        apiPrefix: '/api',
        endpoints: {}
    };

    // ä½¿ç”¨ç«‹å³æ‰§è¡Œå‡½æ•°ï¼Œä¿è¯é…ç½®åœ¨DOMåŠ è½½å‰å¯åŠ¨
    (async function initConfig() {
        try {
            // å°è¯•ä»GitHubåŠ è½½
            const githubResponse = await fetch('https://raw.githubusercontent.com/QSNTH/KY-Secret-V3/refs/heads/main/config.json');
            const githubConfig = await githubResponse.json();
            
            window.KY_CONFIG.backendUrl = githubConfig.backend || githubConfig.backendBaseUrl;
            window.KY_CONFIG.apiPrefix = githubConfig.api || '/api';
            window.KY_CONFIG.endpoints = githubConfig;
            
            console.log('âœ… é…ç½®åŠ è½½æˆåŠŸ:', window.KY_CONFIG.backendUrl);
        } catch (e) {
            console.warn('âš ï¸ GitHubé…ç½®åŠ è½½å¤±è´¥ï¼Œå°è¯•æœ¬åœ°é…ç½®...');
            
            try {
                const localResponse = await fetch('/config.json');
                const localConfig = await localResponse.json();
                
                window.KY_CONFIG.backendUrl = localConfig.backend;
                window.KY_CONFIG.apiPrefix = localConfig.api || '/api';
                window.KY_CONFIG.endpoints = localConfig;
                
                console.log('âœ… æœ¬åœ°é…ç½®åŠ è½½æˆåŠŸ');
            } catch (e2) {
                console.warn('âš ï¸ æœ¬åœ°é…ç½®ä¹Ÿå¤±è´¥ï¼Œä½¿ç”¨ç¡¬ç¼–ç å¤‡ä»½');
                
                window.KY_CONFIG.backendUrl = 'https://pvc-coins-productivity-dropped.trycloudflare.com';
                window.KY_CONFIG.apiPrefix = '/api';
                window.KY_CONFIG.endpoints = {
                    submit: '/submit',
                    lookup: '/lookup/{uuid}',
                    status: '/status',
                    admin_login: '/admin/login',
                    admin_logout: '/admin/logout',
                    admin_find: '/admin/find',
                    admin_review: '/admin/review',
                    admin_history: '/admin/history'
                };
            }
        }
        
        // æŒ‚è½½å·¥å…·å‡½æ•°
        window.KY_CONFIG.getUrl = function(endpoint, params = {}) {
            let path = window.KY_CONFIG.endpoints[endpoint];
            
            // å¦‚æœendpointæ˜¯å®Œæ•´è·¯å¾„ï¼ˆä»¥/å¼€å¤´ï¼‰å°±ç›´æ¥ä½¿ç”¨ï¼Œå¦åˆ™ä»endpointsè·å–
            if (!path) {
                // å°è¯•ç›´æ¥ä½¿ç”¨ä¼ å…¥çš„å­—ç¬¦ä¸²ä½œä¸ºè·¯å¾„
                path = endpoint.startsWith('/') ? endpoint : `/${endpoint}`;
            }
            
            // æ›¿æ¢è·¯å¾„å‚æ•° {uuid} ç­‰
            Object.keys(params).forEach(key => {
                path = path.replace(`{${key}}`, params[key]);
            });
            
            return `${window.KY_CONFIG.backendUrl}${window.KY_CONFIG.apiPrefix}${path}`;
        };
        
        // é…ç½®åŠ è½½å®Œæˆåè§¦å‘è¡¨å•å¯ä»¥æäº¤
        window.dispatchEvent(new CustomEvent('configLoaded', { detail: window.KY_CONFIG }));
    })();
    </script>
    <style>
        /* æ‚¨çš„åŸæœ‰æ ·å¼ä¿æŒä¸å˜ */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        }

        body {
            background: #f7fafc;
            padding: 2rem 1rem;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
        }

        .ky-container {
            max-width: 780px;
            width: 100%;
            margin: 0 auto;
        }

        .nav-header {
            text-align: center;
            margin-bottom: 2.5rem;
        }

        .logo {
            font-size: 5rem;
            font-weight: 900;
            color: #000000;
            letter-spacing: -0.02em;
            margin-bottom: 0.5rem;
            line-height: 1;
        }

        .nav-buttons {
            display: flex;
            gap: 0.75rem;
            justify-content: center;
            margin-bottom: 1.2rem;
        }

        .nav-btn {
            padding: 0.5rem 1.4rem;
            border: 1px solid #e2e8f0;
            border-radius: 40px;
            background: #ffffff;
            color: #334155;
            text-decoration: none;
            font-size: 0.9rem;
            font-weight: 550;
            transition: 0.15s;
            box-shadow: 0 1px 2px rgba(0,0,0,0.02);
        }

        .nav-btn:hover {
            background: #eef2f6;
            border-color: #cbd5e1;
        }

        .nav-btn.active {
            background: #0f172a;
            color: white;
            border-color: #0f172a;
        }

        .submit-card {
            background: white;
            border-radius: 28px;
            border: 1px solid #ecf1f7;
            box-shadow: 0 4px 14px rgba(0, 20, 40, 0.02);
            padding: 2rem 2rem 2.2rem;
            margin-bottom: 1.5rem;
        }

        .form-header {
            margin-bottom: 2rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .form-header h1 {
            font-size: 1.65rem;
            font-weight: 700;
            color: #0f2a40;
            letter-spacing: -0.3px;
            display: flex;
            align-items: center;
            gap: 0.6rem;
        }

        .form-header h1::before {
            content: "âœï¸";
            font-size: 1.8rem;
        }

        .form-badge {
            background: #eef4ff;
            padding: 0.35rem 1rem;
            border-radius: 60px;
            font-size: 0.75rem;
            font-weight: 650;
            color: #2563eb;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            border: 1px solid #dbeafe;
        }

        .form-item {
            margin-bottom: 1.8rem;
        }

        .form-item label {
            display: flex;
            justify-content: space-between;
            align-items: baseline;
            margin-bottom: 0.6rem;
            font-size: 0.95rem;
            font-weight: 600;
            color: #1e3f5c;
            letter-spacing: -0.2px;
        }

        .label-left {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .char-counter {
            font-size: 0.75rem;
            font-weight: 500;
            color: #6f8a9f;
            background: #f1f7fd;
            padding: 0.25rem 0.8rem;
            border-radius: 60px;
        }

        input, textarea {
            width: 100%;
            padding: 0.9rem 1.2rem;
            border: 1.5px solid #e2ecf5;
            border-radius: 20px;
            font-size: 0.95rem;
            background: #ffffff;
            transition: all 0.15s;
            color: #1f3a57;
            outline: none;
        }

        input:focus, textarea:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59,130,246,0.08);
            background: #ffffff;
        }

        textarea {
            min-height: 200px;
            resize: vertical;
            line-height: 1.6;
        }

        .field-hint {
            margin-top: 0.4rem;
            font-size: 0.72rem;
            color: #6f8faa;
            display: flex;
            align-items: center;
            gap: 0.3rem;
            background: #f4faff;
            padding: 0.3rem 0.9rem;
            border-radius: 60px;
            width: fit-content;
        }

        .image-zone {
            background: #fafeff;
            border: 1.5px dashed #cde0ed;
            border-radius: 24px;
            padding: 1.2rem 1.2rem 1rem;
            transition: background 0.1s;
        }

        .image-zone:hover {
            background: #f2f9ff;
            border-color: #91b8d9;
        }

        .image-upload-btn {
            display: flex;
            align-items: center;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .file-input {
            display: none;
        }

        .custom-file-label {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.7rem 1.4rem;
            background: #eef2f6;
            border-radius: 40px;
            font-size: 0.85rem;
            font-weight: 600;
            color: #1e3f5c;
            cursor: pointer;
            transition: 0.15s;
            border: 1px solid #dbe2ec;
        }

        .custom-file-label:hover {
            background: #e2eaf1;
            border-color: #9fb8d0;
        }

        .file-hint {
            color: #557a99;
            font-size: 0.8rem;
        }

        .image-preview {
            display: flex;
            gap: 0.8rem;
            flex-wrap: wrap;
            margin-top: 1.2rem;
            padding-top: 0.8rem;
            border-top: 1px solid #e2ecf5;
        }

        .preview-item {
            position: relative;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 2px 6px rgba(0,0,0,0.04);
        }

        .preview-item img {
            display: block;
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 14px;
            border: 2px solid white;
            box-shadow: 0 2px 6px rgba(0,0,0,0.05);
        }

        .submit-btn {
            width: 100%;
            padding: 1rem 1.5rem;
            background: #0f172a;
            color: white;
            border: none;
            border-radius: 40px;
            font-size: 1.1rem;
            font-weight: 650;
            letter-spacing: 0.5px;
            cursor: pointer;
            transition: 0.15s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.6rem;
            margin-top: 1.2rem;
            border: 1px solid #1e2a44;
        }

        .submit-btn:hover {
            background: #1e2f45;
            transform: scale(1.01);
            box-shadow: 0 8px 18px rgba(15,35,60,0.12);
        }

        .submit-btn:active {
            transform: scale(0.99);
        }

        .footer-note {
            text-align: center;
            margin-top: 1.8rem;
            font-size: 0.75rem;
            color: #7996ae;
            border-top: 1px solid #e2ecf5;
            padding-top: 1.8rem;
        }

        .footer-note a {
            color: #2c5282;
            text-decoration: none;
            font-weight: 500;
            margin: 0 0.4rem;
        }

        .footer-note a:hover {
            text-decoration: underline;
        }

        @media (max-width: 550px) {
            .logo { font-size: 4rem; }
            .submit-card { padding: 1.5rem; }
            .form-header { flex-direction: column; align-items: flex-start; gap: 0.6rem; }
        }

        .tip-text {
            background: #f1f9f0;
            color: #1f6e4a;
            border-radius: 60px;
            padding: 0.2rem 0.8rem;
            font-size: 0.7rem;
        }
    </style>
</head>
<body>
    <div class="ky-container">
        <div class="nav-header">
            <div class="logo">KYSECRET</div>
            <div class="nav-buttons">
                <a href="./index.html" class="nav-btn">ğŸ“Š çŠ¶æ€</a>
                <a href="https://ky-secret-v3.pages.dev/status/history" class="nav-btn">ğŸ“‹ å†å²</a>
                <a href="#" class="nav-btn active">âœ‰ï¸ æŠ•ç¨¿</a>
            </div>
        </div>

        <div class="submit-card">
            <div class="form-header">
                <h1>åŒ¿åæŠ•ç¨¿</h1>
                <span class="form-badge">V3 Â· HTTPSåŠ å¯†</span>
            </div>

            <form id="kySubmitForm" enctype="multipart/form-data">
                <div class="form-item">
                    <label>
                        <span class="label-left">
                            <span>ğŸ“Œ æ ‡é¢˜</span>
                            <span class="tip-text">é€‰å¡«</span>
                        </span>
                        <span class="char-counter" id="titleCounter">0/20</span>
                    </label>
                    <input type="text" id="title" maxlength="20" placeholder="ç»™ä½ çš„æŠ•ç¨¿èµ·ä¸ªæ ‡é¢˜ï¼ˆ20å­—ä»¥å†…ï¼‰" autocomplete="off">
                    <div class="field-hint">
                        <span>âœ¨</span> å¥½çš„æ ‡é¢˜æ›´å®¹æ˜“è¢«çœ‹è§
                    </div>
                </div>

                <div class="form-item">
                    <label>
                        <span class="label-left">
                            <span>ğŸ“„ åŒ¿åå†…å®¹</span>
                            <span style="color:#c53030; margin-left: 4px;">*</span>
                        </span>
                        <span class="char-counter" id="contentCounter">0/2000</span>
                    </label>
                    <textarea id="content" maxlength="2000" placeholder="å†™ä¸‹ä½ æƒ³åˆ†äº«çš„ä¸€åˆ‡â€¦â€¦ æ”¯æŒ2000å­—"></textarea>
                </div>
                <!--
                <div class="form-item">
                    <label>
                        <span class="label-left">
                            <span>ğŸ·ï¸ æ ‡ç­¾</span>
                        </span>
                    </label>
                    <input type="text" id="tag" placeholder="ä¾‹ï¼š#æ ¡å›­ #åŒ¿åæ•…äº‹ ç”¨#åˆ†éš”" autocomplete="off">
                    <div class="field-hint">
                        <span>ğŸ”–</span> æ¨èæ·»åŠ  #å­¦æ ¡  #ç”Ÿæ´»  #æ ‘æ´
                    </div>
                </div>
                -->

                <div class="form-item">
                    <label>
                        <span class="label-left">
                            <span>ğŸ–¼ï¸ ä¸Šä¼ å›¾ç‰‡</span>
                            <span class="tip-text">å¯é€‰ï¼Œæœ€å¤š5å¼ </span>
                        </span>
                    </label>
                    <div class="image-zone">
                        <div class="image-upload-btn">
                            <input type="file" id="imageFiles" class="file-input" accept="image/*" multiple>
                            <label for="imageFiles" class="custom-file-label">
                                <span style="font-size:1.2rem;">ğŸ“</span> é€‰æ‹©å›¾ç‰‡
                            </label>
                            <span class="file-hint" id="fileCountHint">æœªé€‰æ‹©ä»»ä½•æ–‡ä»¶</span>
                        </div>
                        <div class="image-preview" id="imagePreviewContainer"></div>
                    </div>
                </div>

                <button type="submit" class="submit-btn">
                    <span>âœˆï¸</span> åŒ¿åæäº¤
                </button>
            </form>

            <div style="margin-top: 1.8rem; font-size: 0.7rem; color: #6a889b; text-align: center; border-top: 1px solid #ecf5fa; padding-top: 1.2rem;">
                âš¡ æŠ•ç¨¿åç»è¿‡äººå·¥å®¡æ ¸å±•ç¤º Â· ä¸ä¼šå…¬å¼€ä½ çš„ä»»ä½•ä¸ªäººä¿¡æ¯
            </div>
        </div>

        <div class="footer-note">
            <a href="./index.html">â† å½“å‰çŠ¶æ€</a> Â· 
            <a href="https://ky-secret-v3.pages.dev/status/history">ğŸ“‹ å†å²äº‹ä»¶</a> Â· 
            <a href="#">ğŸ“¡ è®¢é˜…</a>
        </div>
    </div>

    <script>
        (function() {
            "use strict";

            // DOM å…ƒç´ 
            const titleInput = document.getElementById('title');
            const contentInput = document.getElementById('content');
            const tagInput = document.getElementById('tag');
            const titleCounter = document.getElementById('titleCounter');
            const contentCounter = document.getElementById('contentCounter');
            const fileInput = document.getElementById('imageFiles');
            const fileHint = document.getElementById('fileCountHint');
            const previewContainer = document.getElementById('imagePreviewContainer');
            const form = document.getElementById('kySubmitForm');
            
            let isSubmitting = false;

            // å­—æ•°ç»Ÿè®¡
            function updateTitleCounter() {
                titleCounter.innerText = `${titleInput.value.length}/20`;
            }
            function updateContentCounter() {
                contentCounter.innerText = `${contentInput.value.length}/2000`;
            }

            titleInput.addEventListener('input', updateTitleCounter);
            contentInput.addEventListener('input', updateContentCounter);
            updateTitleCounter();
            updateContentCounter();

            // å›¾ç‰‡é¢„è§ˆ
            fileInput.addEventListener('change', function(e) {
                const files = Array.from(fileInput.files);
                if (files.length === 0) {
                    fileHint.innerText = 'æœªé€‰æ‹©ä»»ä½•æ–‡ä»¶';
                    previewContainer.innerHTML = '';
                    return;
                }

                if (files.length > 5) {
                    alert('æœ€å¤šåªèƒ½ä¸Šä¼ 5å¼ å›¾ç‰‡ï¼Œè¶…å‡ºéƒ¨åˆ†ä¸ä¼šè¢«æäº¤');
                    const dt = new DataTransfer();
                    files.slice(0, 5).forEach(f => dt.items.add(f));
                    fileInput.files = dt.files;
                }

                const validFiles = Array.from(fileInput.files);
                fileHint.innerText = `å·²é€‰æ‹© ${validFiles.length} ä¸ªæ–‡ä»¶`;
                previewContainer.innerHTML = '';

                validFiles.forEach(file => {
                    if (file.type.startsWith('image/')) {
                        const reader = new FileReader();
                        reader.onload = (ev) => {
                            const previewItem = document.createElement('div');
                            previewItem.className = 'preview-item';
                            const img = document.createElement('img');
                            img.src = ev.target.result;
                            previewItem.appendChild(img);
                            previewContainer.appendChild(previewItem);
                        };
                        reader.readAsDataURL(file);
                    }
                });
            });

            // ç­‰å¾…é…ç½®åŠ è½½å®Œæˆå†å…è®¸æäº¤
            async function waitForConfig() {
                if (window.KY_CONFIG && window.KY_CONFIG.backendUrl) {
                    return true;
                }
                // æœ€å¤šç­‰å¾…3ç§’
                for (let i = 0; i < 30; i++) {
                    await new Promise(resolve => setTimeout(resolve, 100));
                    if (window.KY_CONFIG && window.KY_CONFIG.backendUrl) {
                        return true;
                    }
                }
                return false;
            }

            // è¡¨å•æäº¤
            form.addEventListener('submit', async function(e) {
                e.preventDefault();

                if (isSubmitting) return;
                
                const hasContent = contentInput.value.trim().length > 0;
                const hasTitle = titleInput.value.trim().length > 0;
                const hasImages = fileInput.files.length > 0;

                if (!hasContent && !hasTitle && !hasImages) {
                    alert('è¯·è‡³å°‘å¡«å†™åŒ¿åæŠ•ç¨¿å†…å®¹ã€æ ‡é¢˜æˆ–ä¸Šä¼ ä¸€å¼ å›¾ç‰‡');
                    return;
                }

                // ç­‰å¾…é…ç½®åŠ è½½
                const configReady = await waitForConfig();
                if (!configReady) {
                    alert('é…ç½®åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
                    return;
                }

                // æ„å»º FormData
                const formData = new FormData();
                formData.append('title', titleInput.value.trim());
                formData.append('content', contentInput.value.trim());
                formData.append('tag', tagInput.value.trim() || '');

                const files = fileInput.files;
                for (let i = 0; i < files.length; i++) {
                    formData.append('images', files[i]);
                }

                // ä½¿ç”¨åŠ¨æ€é…ç½®æ„å»ºURL
                const SUBMIT_ENDPOINT = window.KY_CONFIG.getUrl('submit');

                const submitBtn = document.querySelector('.submit-btn');
                const originalText = submitBtn.innerHTML;
                submitBtn.innerHTML = '<span>â³</span> æäº¤ä¸­...';
                submitBtn.disabled = true;
                isSubmitting = true;

                try {
                    const response = await fetch(SUBMIT_ENDPOINT, {
                        method: 'POST',
                        body: formData
                    });

                    if (!response.ok) {
                        const errorText = await response.text();
                        throw new Error(`HTTP ${response.status}: ${errorText}`);
                    }

                    const data = await response.json();
                    alert('âœ… æŠ•ç¨¿æäº¤æˆåŠŸï¼æ„Ÿè°¢ä½ çš„åˆ†äº«ã€‚å®¡æ ¸é€šè¿‡åå°†å‘å¸ƒã€‚');
                    
                    form.reset();
                    previewContainer.innerHTML = '';
                    fileHint.innerText = 'æœªé€‰æ‹©ä»»ä½•æ–‡ä»¶';
                    titleCounter.innerText = '0/20';
                    contentCounter.innerText = '0/2000';
                    
                } catch (error) {
                    console.error('æäº¤å¤±è´¥:', error);
                    alert('âŒ æŠ•ç¨¿æäº¤å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•ã€‚' + (error.message ? `\n${error.message}` : ''));
                } finally {
                    submitBtn.innerHTML = originalText;
                    submitBtn.disabled = false;
                    isSubmitting = false;
                }
            });

        })();
    </script>
</body>
</html>