<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.5">
  <title>KY Secret Â· å®æ—¶æœåŠ¡çŠ¶æ€</title>
  <style>
    /* ===== KY Secret V3 ç»Ÿä¸€é£æ ¼ ===== */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
    }

    body {
      background: #f7fafc;
      padding: 2rem 1rem;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      min-height: 100vh;
    }

    .ky-container {
      max-width: 780px;
      width: 100%;
      margin: 0 auto;
    }

    .nav-header {
      text-align: center;
      margin-bottom: 2.5rem;
    }

    .logo {
      font-size: 5rem;
      font-weight: 900;
      color: #000000;
      letter-spacing: -0.02em;
      margin-bottom: 0.5rem;
      line-height: 1;
    }

    .nav-buttons {
      display: flex;
      gap: 0.75rem;
      justify-content: center;
      margin-bottom: 1.2rem;
    }

    .nav-btn {
      padding: 0.5rem 1.4rem;
      border: 1px solid #e2e8f0;
      border-radius: 40px;
      background: #ffffff;
      color: #334155;
      text-decoration: none;
      font-size: 0.9rem;
      font-weight: 550;
      transition: 0.15s;
      box-shadow: 0 1px 2px rgba(0,0,0,0.02);
    }

    .nav-btn:hover {
      background: #eef2f6;
      border-color: #cbd5e1;
    }

    .nav-btn.active {
      background: #0f172a;
      color: white;
      border-color: #0f172a;
    }

    /* å…¨å±€çŠ¶æ€æ¨ªå¹… */
    .global-status-banner {
      background: #f1f7fd;
      border-radius: 60px;
      padding: 0.9rem 1.5rem;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.6rem;
      margin: 0 auto 1.5rem;
      font-size: 0.9rem;
      font-weight: 550;
      color: #1e3f5c;
      border: 1px solid #dde9f5;
    }

    .global-dot {
      width: 12px;
      height: 12px;
      border-radius: 12px;
      background: #94a3b8;
    }

    .global-dot.ok { background: #0f7b4b; }
    .global-dot.degraded { background: #e68a2e; }
    .global-dot.down { background: #c62a2a; }

    /* æœåŠ¡å¡ç‰‡ */
    .section {
      background: white;
      border-radius: 28px;
      margin-bottom: 1.8rem;
      border: 1px solid #ecf1f7;
      box-shadow: 0 4px 14px rgba(0, 20, 40, 0.02);
      overflow: hidden;
    }

    .section-header {
      padding: 1.2rem 1.5rem 0.5rem 1.5rem;
      font-size: 1.05rem;
      font-weight: 700;
      color: #0f2a40;
      display: flex;
      align-items: center;
      letter-spacing: -0.2px;
    }

    .section-header span {
      background: #eef4ff;
      padding: 0.2rem 0.8rem;
      border-radius: 30px;
      font-size: 0.7rem;
      font-weight: 600;
      color: #2563eb;
      margin-left: 0.7rem;
    }

    .service-list {
      padding: 0.2rem 0.2rem 0.8rem 0.2rem;
    }

    .service-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 1rem 1.5rem;
      margin: 0.2rem 0.4rem;
      border-radius: 18px;
      background: #ffffff;
      transition: background 0.15s;
    }

    .service-item:nth-child(even) {
      background: #fafdff;
    }

    .service-left {
      display: flex;
      align-items: center;
      gap: 0.9rem;
      flex-wrap: wrap;
    }

    .status-indicator {
      width: 14px;
      height: 14px;
      border-radius: 14px;
      background: #cbd5e1;
      transition: background 0.2s ease;
    }

    .status-indicator.operational { background: #0a8f5a; }
    .status-indicator.degraded { background: #e68a2e; }
    .status-indicator.down { background: #cd3c30; }
    .status-indicator.unknown { background: #94a3b8; }

    .service-name {
      font-weight: 570;
      color: #0e2f44;
      font-size: 0.98rem;
    }

    .service-endpoint {
      font-size: 0.7rem;
      color: #607b96;
      background: #eef4fa;
      padding: 0.2rem 0.7rem;
      border-radius: 40px;
      font-family: monospace;
    }

    .status-text {
      font-weight: 640;
      font-size: 0.85rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .status-badge {
      padding: 0.3rem 0.9rem;
      border-radius: 100px;
      font-size: 0.75rem;
      font-weight: 650;
      text-transform: uppercase;
      letter-spacing: 0.3px;
    }

    .badge-operational {
      background: #e1f7ed;
      color: #0a6d47;
    }

    .badge-degraded {
      background: #ffeed9;
      color: #a3500a;
    }

    .badge-down {
      background: #ffe6e5;
      color: #b11f1a;
    }

    .badge-unknown {
      background: #edf2f7;
      color: #4a627a;
    }

    /* æ£€æµ‹æ—¶é—´ & åˆ·æ–°æ§ä»¶ */
    .check-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 0.8rem;
      padding: 1rem 1.5rem 1.2rem 1.5rem;
      border-top: 1px solid #e6edf4;
      color: #5a7188;
      font-size: 0.78rem;
      flex-wrap: wrap;
    }

    .last-check {
      display: flex;
      align-items: center;
      gap: 0.4rem;
    }

    .refresh-btn {
      background: white;
      border: 1px solid #cde0ed;
      padding: 0.4rem 1.1rem;
      border-radius: 60px;
      font-size: 0.75rem;
      font-weight: 600;
      color: #1c4e6e;
      cursor: pointer;
      transition: 0.15s;
      display: flex;
      align-items: center;
      gap: 0.4rem;
    }

    .refresh-btn:hover {
      background: #e7f0f9;
      border-color: #95b3cc;
    }

    /* é¡µè„šå¯¼èˆª - ç»Ÿä¸€é£æ ¼ */
    .footer-note {
      text-align: center;
      margin-top: 1.8rem;
      font-size: 0.75rem;
      color: #7996ae;
      border-top: 1px solid #e2ecf5;
      padding-top: 1.8rem;
    }

    .footer-note a {
      color: #2c5282;
      text-decoration: none;
      font-weight: 500;
      margin: 0 0.4rem;
    }

    .footer-note a:hover {
      text-decoration: underline;
    }

    @media (max-width: 550px) {
      .logo { font-size: 4rem; }
      .service-item { flex-wrap: wrap; gap: 0.6rem; }
      .status-text { width: 100%; margin-left: 1.8rem; }
    }
  </style>
</head>
<body>
  <div class="ky-container">
    <!-- å¤´éƒ¨ï¼šç»Ÿä¸€å¯¼èˆªï¼Œä¸‰ä¸ªæŒ‰é’®é½å…¨ -->
    <div class="nav-header">
      <div class="logo">KYSECRET</div>
      <div class="nav-buttons">
        <a href="./index.html" class="nav-btn active">ğŸ“Š çŠ¶æ€</a>
        <a href="./history.html" class="nav-btn">ğŸ“‹ å†å²</a>
        <a href="../index.html" class="nav-btn">âœ‰ï¸ æŠ•ç¨¿</a>
      </div>

      <!-- å…¨å±€å¥åº·çŠ¶æ€ -->
      <div id="globalBanner" class="global-status-banner">
        <span id="globalDot" class="global-dot"></span>
        <span id="globalMessage">æ­£åœ¨æ£€æµ‹æœåŠ¡çŠ¶æ€...</span>
      </div>
    </div>

    <!-- ========= å‰ç«¯æ‰˜ç®¡ ========= -->
    <div class="section">
      <div class="section-header">
        ğŸŒ å‰ç«¯æ‰˜ç®¡
        <span id="frontend-count">2 æœåŠ¡</span>
      </div>
      <div class="service-list">
        <!-- Cloudflare Pages -->
        <div class="service-item" id="service-cf">
          <div class="service-left">
            <span class="status-indicator" id="indicator-cf"></span>
            <span class="service-name">Cloudflare Pages</span>
            <span class="service-endpoint">pages.kysecret.dev</span>
          </div>
          <div class="status-text">
            <span id="status-badge-cf" class="status-badge badge-operational">æ£€æµ‹ä¸­...</span>
          </div>
        </div>
        <!-- GitHub Pages -->
        <div class="service-item" id="service-gh">
          <div class="service-left">
            <span class="status-indicator" id="indicator-gh"></span>
            <span class="service-name">GitHub Pages</span>
            <span class="service-endpoint">ky-secret-v3.pages.dev</span>
          </div>
          <div class="status-text">
            <span id="status-badge-gh" class="status-badge badge-operational">æ£€æµ‹ä¸­...</span>
          </div>
        </div>
      </div>
    </div>

    <!-- ========= åç«¯æ ¸å¿ƒ ========= -->
    <div class="section">
      <div class="section-header">
        âš™ï¸ åç«¯æ ¸å¿ƒ
        <span id="backend-count">2 æœåŠ¡</span>
      </div>
      <div class="service-list">
        <!-- Backend API (è¿æ¥çœŸå®åç«¯) -->
        <div class="service-item" id="service-api">
          <div class="service-left">
            <span class="status-indicator" id="indicator-api"></span>
            <span class="service-name">Backend API</span>
            <span class="service-endpoint" id="api-endpoint">åŠ è½½ä¸­...</span>
          </div>
          <div class="status-text">
            <span id="status-badge-api" class="status-badge badge-unknown">æ£€æµ‹ä¸­...</span>
          </div>
        </div>
        <!-- æ•°æ®åº“ -->
        <div class="service-item" id="service-db">
          <div class="service-left">
            <span class="status-indicator" id="indicator-db"></span>
            <span class="service-name">Database</span>
            <span class="service-endpoint">SQLite</span>
          </div>
          <div class="status-text">
            <span id="status-badge-db" class="status-badge badge-unknown">æ£€æµ‹ä¸­...</span>
          </div>
        </div>
      </div>
    </div>

    <!-- ========= ç®¡ç†åå° ========= -->
    <div class="section">
      <div class="section-header">
        ğŸ” ç®¡ç†åå°
        <span id="admin-count">2 æœåŠ¡</span>
      </div>
      <div class="service-list">
        <!-- Admin Login -->
        <div class="service-item" id="service-login">
          <div class="service-left">
            <span class="status-indicator" id="indicator-login"></span>
            <span class="service-name">Admin ç™»å½•</span>
            <span class="service-endpoint">/api/admin/login</span>
          </div>
          <div class="status-text">
            <span id="status-badge-login" class="status-badge badge-unknown">æ£€æµ‹ä¸­...</span>
          </div>
        </div>
        <!-- Admin Review -->
        <div class="service-item" id="service-review">
          <div class="service-left">
            <span class="status-indicator" id="indicator-review"></span>
            <span class="service-name">Admin å®¡æ ¸</span>
            <span class="service-endpoint">/api/admin/review</span>
          </div>
          <div class="status-text">
            <span id="status-badge-review" class="status-badge badge-unknown">æ£€æµ‹ä¸­...</span>
          </div>
        </div>
      </div>

      <!-- æ£€æµ‹ä¿¡æ¯æ  -->
      <div class="check-footer">
        <div class="last-check">
          <span>ğŸ•’ æœ€åæ£€æµ‹: </span>
          <span id="lastCheckTime">åˆšåˆš</span>
        </div>
        <div id="manualRefreshBtn" class="refresh-btn">
          <span>âŸ³</span> ç«‹å³æ£€æµ‹
        </div>
      </div>
    </div>

    <!-- é¡µè„šå¯¼èˆª - ç»Ÿä¸€é£æ ¼ -->
    <div class="footer-note">
      <a href="./index.html">ğŸ“Š å½“å‰çŠ¶æ€</a> Â· 
      <a href="./history.html">ğŸ“‹ å†å²äº‹ä»¶</a> Â· 
      <a href="../index.html">âœ‰ï¸ åŒ¿åæŠ•ç¨¿</a>
    </div>
  </div>

  <script>
    (function() {
      "use strict";

      // é…ç½®åŠ è½½
      async function loadConfig() {
        try {
          const response = await fetch('https://raw.githubusercontent.com/QSNTH/KY-Secret-V3/refs/heads/main/config.json');
          const config = await response.json();
          return config;
        } catch (e) {
          console.warn('æ— æ³•åŠ è½½é…ç½®ï¼Œä½¿ç”¨é»˜è®¤å€¼');
          return {
            backend: 'http://192.168.254.246:8000',
            api: '/api'
          };
        }
      }

      // æœåŠ¡çŠ¶æ€æšä¸¾
      const STATUS = {
        OPERATIONAL: 'operational',
        DEGRADED: 'degraded',
        DOWN: 'down',
        UNKNOWN: 'unknown'
      };

      let currentStatus = {};
      let backendUrl = '';
      let lastCheckTimestamp = Date.now();

      // æ›´æ–°UI
      function updateServiceUI(id, state, message = '') {
        const indicator = document.getElementById(`indicator-${id}`);
        const badge = document.getElementById(`status-badge-${id}`);
        const hintEl = document.getElementById(`hint-${id}`);
        
        if (indicator) {
          indicator.className = 'status-indicator';
          indicator.classList.add(state);
        }
        
        if (badge) {
          let text = '';
          let badgeClass = '';
          switch (state) {
            case STATUS.OPERATIONAL:
              text = 'æ­£å¸¸';
              badgeClass = 'badge-operational';
              break;
            case STATUS.DEGRADED:
              text = 'é™çº§';
              badgeClass = 'badge-degraded';
              break;
            case STATUS.DOWN:
              text = 'ç¦»çº¿';
              badgeClass = 'badge-down';
              break;
            default:
              text = 'æœªçŸ¥';
              badgeClass = 'badge-unknown';
          }
          badge.innerText = text;
          badge.className = 'status-badge ' + badgeClass;
        }
        
        if (hintEl) {
          hintEl.innerText = message || '';
          hintEl.style.display = message ? 'inline-block' : 'none';
        }
      }

      // æ›´æ–°å…¨å±€æ¨ªå¹…
      function updateGlobalBanner() {
        const dot = document.getElementById('globalDot');
        const msg = document.getElementById('globalMessage');

        let hasDown = false, hasDegraded = false, hasUnknown = false;
        Object.values(currentStatus).forEach(state => {
          if (state === STATUS.DOWN) hasDown = true;
          else if (state === STATUS.DEGRADED) hasDegraded = true;
          else if (state === STATUS.UNKNOWN) hasUnknown = true;
        });

        if (hasDown) {
          dot.className = 'global-dot down';
          msg.innerText = 'éƒ¨åˆ†æœåŠ¡ç¦»çº¿';
        } else if (hasDegraded) {
          dot.className = 'global-dot degraded';
          msg.innerText = 'æœåŠ¡é™çº§';
        } else if (hasUnknown) {
          dot.className = 'global-dot unknown';
          msg.innerText = 'éƒ¨åˆ†çŠ¶æ€æœªçŸ¥';
        } else {
          dot.className = 'global-dot ok';
          msg.innerText = 'æ‰€æœ‰ç³»ç»Ÿæ­£å¸¸';
        }
      }

      // æ£€æµ‹åç«¯API
      async function checkBackendAPI() {
        if (!backendUrl) return STATUS.UNKNOWN;
        
        try {
          const controller = new AbortController();
          const timeoutId = setTimeout(() => controller.abort(), 5000);
          
          const response = await fetch(`${backendUrl}/health`, {
            signal: controller.signal
          });
          
          clearTimeout(timeoutId);
          
          if (response.ok) {
            return STATUS.OPERATIONAL;
          } else {
            return STATUS.DEGRADED;
          }
        } catch (error) {
          console.warn('åç«¯APIæ£€æµ‹å¤±è´¥:', error);
          return STATUS.DOWN;
        }
      }

      // æ£€æµ‹æ•°æ®åº“ï¼ˆé€šè¿‡APIé—´æ¥æ£€æµ‹ï¼‰
      async function checkDatabase() {
        if (!backendUrl) return STATUS.UNKNOWN;
        
        try {
          const response = await fetch(`${backendUrl}/api/status`);
          if (response.ok) {
            return STATUS.OPERATIONAL;
          }
          return STATUS.DEGRADED;
        } catch {
          return STATUS.DOWN;
        }
      }

      // æ£€æµ‹ç®¡ç†æ¥å£
      async function checkAdminEndpoint(endpoint) {
        if (!backendUrl) return STATUS.UNKNOWN;
        
        try {
          const response = await fetch(`${backendUrl}${endpoint}`, {
            method: endpoint.includes('login') ? 'POST' : 'GET',
            headers: { 'Content-Type': 'application/json' }
          });
          
          // 401æ˜¯é¢„æœŸçš„ï¼ˆæœªç™»å½•ï¼‰ï¼Œè¯´æ˜æ¥å£æœ¬èº«å¯ç”¨
          if (response.status === 401 || response.status === 200) {
            return STATUS.OPERATIONAL;
          } else if (response.status >= 500) {
            return STATUS.DOWN;
          } else {
            return STATUS.DEGRADED;
          }
        } catch {
          return STATUS.DOWN;
        }
      }

      // æ‰§è¡Œæ‰€æœ‰æ£€æµ‹
      async function performHealthCheck() {
        const config = await loadConfig();
        backendUrl = config.backend || 'http://192.168.254.246:8000';
        
        // æ›´æ–°APIç«¯ç‚¹æ˜¾ç¤º
        const apiEndpoint = document.getElementById('api-endpoint');
        if (apiEndpoint) {
          apiEndpoint.innerText = backendUrl.replace(/^https?:\/\//, '');
        }

        // å¹¶è¡Œæ£€æµ‹æ‰€æœ‰æœåŠ¡
        const results = await Promise.allSettled([
          checkBackendAPI().then(state => ({ id: 'api', state })),
          checkDatabase().then(state => ({ id: 'db', state })),
          checkAdminEndpoint('/api/admin/login').then(state => ({ id: 'login', state })),
          checkAdminEndpoint('/api/admin/review').then(state => ({ id: 'review', state }))
        ]);

        // å‰ç«¯æœåŠ¡å›ºå®šä¸ºæ­£å¸¸
        currentStatus = {
          cf: STATUS.OPERATIONAL,
          gh: STATUS.OPERATIONAL,
          api: STATUS.UNKNOWN,
          db: STATUS.UNKNOWN,
          login: STATUS.UNKNOWN,
          review: STATUS.UNKNOWN
        };

        // æ›´æ–°æ£€æµ‹ç»“æœ
        results.forEach(result => {
          if (result.status === 'fulfilled' && result.value) {
            currentStatus[result.value.id] = result.value.state;
          }
        });

        // æ›´æ–°UI
        Object.entries(currentStatus).forEach(([id, state]) => {
          updateServiceUI(id, state);
        });

        // æ›´æ–°å…¨å±€çŠ¶æ€
        updateGlobalBanner();

        // æ›´æ–°æ—¶é—´æˆ³
        lastCheckTimestamp = Date.now();
        const lastTimeEl = document.getElementById('lastCheckTime');
        if (lastTimeEl) {
          const date = new Date(lastCheckTimestamp);
          const timeStr = `${date.getHours().toString().padStart(2,'0')}:${date.getMinutes().toString().padStart(2,'0')}:${date.getSeconds().toString().padStart(2,'0')}`;
          lastTimeEl.innerText = timeStr;
        }
      }

      // åˆå§‹åŒ–
      async function init() {
        // å…ˆæ˜¾ç¤º"æ£€æµ‹ä¸­"
        ['cf', 'gh', 'api', 'db', 'login', 'review'].forEach(id => {
          updateServiceUI(id, STATUS.UNKNOWN);
        });

        await performHealthCheck();

        // ç»‘å®šåˆ·æ–°æŒ‰é’®
        const refreshBtn = document.getElementById('manualRefreshBtn');
        if (refreshBtn) {
          refreshBtn.addEventListener('click', async (e) => {
            e.preventDefault();
            await performHealthCheck();
          });
        }

        // è‡ªåŠ¨åˆ·æ–°ï¼ˆæ¯60ç§’ï¼‰
        setInterval(performHealthCheck, 60000);
      }

      init();
    })();
  </script>
</body>
</html>