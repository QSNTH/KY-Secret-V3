<script>
    (function() {
        "use strict";

        // DOM å…ƒç´ 
        const apiBaseUrlInput = document.getElementById('apiBaseUrl');
        const usernameInput = document.getElementById('username');
        const passwordInput = document.getElementById('password');
        const loginBtn = document.getElementById('loginBtn');
        const loginForm = document.getElementById('loginForm');
        const errorMessage = document.getElementById('errorMessage');
        const errorText = document.getElementById('errorText');
        const loginStatus = document.getElementById('loginStatus');

        // âœ… è®¾ç½®é»˜è®¤ API åœ°å€ä¸ºä½ çš„ Tunnel
        apiBaseUrlInput.value = 'https://households-hartford-glass-optimal.trycloudflare.com';

        // å·¥å…·å‡½æ•°
        function showError(msg) {
            errorText.innerText = msg;
            errorMessage.classList.add('show');
            loginStatus.innerHTML = 'âŒ ' + msg;
        }

        function hideError() {
            errorMessage.classList.remove('show');
        }

        function setLoading(isLoading) {
            if (isLoading) {
                loginBtn.disabled = true;
                loginBtn.innerHTML = '<span class="spinner"></span><span>ç™»å½•ä¸­...</span>';
                loginStatus.innerHTML = 'â³ ç™»å½•ä¸­...';
            } else {
                loginBtn.disabled = false;
                loginBtn.innerHTML = '<span>ğŸ”</span><span>ç™»å½•åå°</span>';
            }
        }

        // è·å–å®Œæ•´çš„ç™»å½•æ¥å£åœ°å€
        function getLoginUrl() {
            let base = apiBaseUrlInput.value.trim();
            if (!base) return '';
            base = base.replace(/\/$/, '');
            return base + '/api/admin/login';  // âœ… æ³¨æ„è·¯å¾„æ˜¯ /api/admin/login
        }

        // æµ‹è¯•è¿æ¥
        window.testConnection = async function() {
            const url = getLoginUrl();
            if (!url) {
                alert('è¯·è¾“å…¥APIåœ°å€');
                return;
            }
            
            loginStatus.innerHTML = 'â³ æµ‹è¯•è¿æ¥ä¸­...';
            try {
                const res = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username: 'test', password: 'test' })  // âœ… ç”¨ password
                });
                
                if (res.ok) {
                    loginStatus.innerHTML = 'âœ… æœåŠ¡å™¨å¯è¿æ¥';
                } else {
                    const data = await res.json().catch(() => ({}));
                    loginStatus.innerHTML = `âš ï¸ æœåŠ¡å™¨å“åº” ${res.status}`;
                }
            } catch (err) {
                loginStatus.innerHTML = 'âŒ æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨';
                console.error(err);
            }
        };

        // ç™»å½•å¤„ç†
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const username = usernameInput.value.trim();
            const password = passwordInput.value.trim();
            const loginUrl = getLoginUrl();

            if (!username || !password) {
                showError('ç”¨æˆ·åå’Œå¯†ç ä¸èƒ½ä¸ºç©º');
                return;
            }

            if (!loginUrl) {
                showError('è¯·è¾“å…¥APIåœ°å€');
                return;
            }

            hideError();
            setLoading(true);

            try {
                console.log('å‘é€ç™»å½•è¯·æ±‚åˆ°:', loginUrl);
                console.log('è¯·æ±‚æ•°æ®:', { username, password });  // âœ… è°ƒè¯•ç”¨
                
                const response = await fetch(loginUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        username: username,
                        password: password  // âœ… å…³é”®ä¿®æ”¹ï¼špwd -> password
                    }),
                    credentials: 'include'  // å…è®¸æºå¸¦ Cookie
                });

                const data = await response.json();
                console.log('ç™»å½•å“åº”:', data);  // âœ… è°ƒè¯•ç”¨

                if (!response.ok) {
                    throw new Error(data.detail || `ç™»å½•å¤±è´¥ (${response.status})`);
                }

                // âœ… åˆ¤æ–­æˆåŠŸæ¡ä»¶ï¼šä½ çš„åç«¯è¿”å› {"ok": true}
                if (data.ok === true) {
                    loginStatus.innerHTML = 'âœ… ç™»å½•æˆåŠŸï¼Œè·³è½¬ä¸­...';
                    
                    // å­˜å‚¨ç”¨æˆ·ä¿¡æ¯
                    localStorage.setItem('admin_user', JSON.stringify({ username }));
                    
                    // è·³è½¬åˆ°ç®¡ç†åå°
                    setTimeout(() => {
                        window.location.href = '/admin/dashboard.html';
                    }, 500);
                } else {
                    throw new Error('ç™»å½•å¤±è´¥ï¼š' + JSON.stringify(data));
                }

            } catch (error) {
                console.error('ç™»å½•é”™è¯¯:', error);
                showError(error.message || 'ç½‘ç»œé”™è¯¯ï¼Œè¯·æ£€æŸ¥æœåŠ¡å™¨æ˜¯å¦è¿è¡Œ');
            } finally {
                setLoading(false);
            }
        });

        // è¾“å…¥æ—¶éšè—é”™è¯¯
        usernameInput.addEventListener('input', hideError);
        passwordInput.addEventListener('input', hideError);

        // è‡ªåŠ¨æµ‹è¯•è¿æ¥
        setTimeout(() => testConnection(), 1000);
    })();
</script>